<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>TeamSharePoint</title>
    <link rel="stylesheet" href="css/todo.css" />
    <style>
      /* ã“ã®ä¸­ã«cssã‚’ã‹ã‘ã¾ã™ */
    </style>
  </head>

  <body>
    <!-- ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”»é¢ã«è¦‹ãˆã‚‹å†…å®¹ -->
    <div>
      <!-- æ—¥ä»˜ -->
      <input type="date" id="date" placeholder="Date" />

      <!-- åå‰ -->
      <input type="text" id="username" placeholder="Author" />
    </div>

    <div>
      <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
      <textarea
        name=""
        id="text"
        cols="30"
        rows="10"
        wrap="hard"
        placeholder="Please enter handovers here"
      ></textarea>
    </div>

    <div>
      <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <button id="send">Send</button>
      <!-- æ›´æ–°ãƒœã‚¿ãƒ³ -->
      <button id="update">Update</button>
      <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
      <button id="Delete">Delete</button>
    </div>

    <div>
      <!-- ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ç®‡æ‰€ -->
      <!-- <div id="output" contenteditable="true"></div> -->
      <table id="output"></table>
    </div>
    <!--/ ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”»é¢ã«è¦‹ãˆã‚‹å†…å®¹ -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!--** ä»¥ä¸‹Firebase **-->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!-- ã“ã“ã«firebaseã®scriptã‚’è²¼ã‚Šä»˜ã‘ã‚‹ & -appã‚’å‰Šé™¤-->
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase.js"></script>
    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCCL8qei8vz0UodYEENwQe7_2tFzW94EcY",
        authDomain: "todolist-90f23.firebaseapp.com",
        databaseURL: "https://todolist-90f23.firebaseio.com",
        projectId: "todolist-90f23",
        storageBucket: "todolist-90f23.appspot.com",
        messagingSenderId: "617897036801",
        appId: "1:617897036801:web:663ad3a3481d927c3ac400",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      //firebaseã®ãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼ˆä¿å­˜ã•ã›ã‚‹å ´æ‰€ï¼‰ã‚’ä½¿ã„ã¾ã™ã‚ˆã¨è¨€ã†jsã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹
      const newPostRef = firebase.database().ref();

      // ã“ã“ã‹ã‚‰ä¸‹ã«jqueryã®å‡¦ç†

      //é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰æ¬¡ã®å‡¦ç†ã‚’ã™ã‚‹
      $("#send").on("click", function () {
        //ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã§é€ã‚‹
        //pushè¨­å®š;
        newPostRef.push({
          date: $("#date").val(), //æ—¥ä»˜
          username: $("#username").val(), //åå‰
          text: $("#text").val(), //ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
        });

        // æ–‡å­—ã‚’ç©ºã«ã™ã‚‹
        $("#date").val("");
        $("#text").val("");
        $("#username").val("");

        //ç©ºæ¬„ã‚¢ãƒ©ãƒ¼ãƒˆ
        // if ($("#date").val() == "") {
        //   alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        //   $(this).focus();
        //   return false;
        // }
        // if ($("#username").val() == "") {
        //   alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        //   return false;
        // }
        // if ($("#text").val() == "") {
        //   alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        //   return false;
        // }

        //é€ä¿¡ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
        alert("é€ä¿¡å®Œäº†ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
      });

      var key_id;

      // å—ä¿¡å‡¦ç†
      newPostRef.on("child_added", function (data) {
        //ã“ã“ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå…¨ã¦å…¥ã£ã¦ãã‚‹
        // function (data)ã®dataã«firebaseã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ãã‚‹
        let v = data.val();
        key_id = data.key;

        console.log(key_id, "key"); //ã“ã‚ŒãŒå›ºæœ‰ã®IDã«ãªã‚‹ã®ã§ã“ã‚Œã‚’å…ƒã«æ›´æ–°ã‚’ã™ã‚‹
        console.log(v, "å—ä¿¡"); //vã®å¤‰æ•°ã«å…¥ã£ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¨ã¦ã¿ã‚‹

        // ã“ã“ãŒæœ€åˆtableã‚¿ã‚°ã‚‚å«ã‚“ã§ã¾ã—ãŸãŒã€ãã‚Œã™ã‚‹ã¨ãŠã‹ã—ããªã‚‹ã®ã§ã€è¿½åŠ ã—ãŸã„ã®ã¯<tr>ã‚¿ã‚°ã‹ã‚‰ã«ãªã‚Šã¾ã™ğŸ™‹â€â™€ï¸OK!
        let str = `<tr class=${key_id}>
            <th class=date contenteditable="true">${v.date}</th>
            <td class=username contenteditable="true">${v.username}</td>
            <td class=text contenteditable="true">${v.text}</td>
          </tr>`;
        // ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ã‚’htmlã«åŸ‹ã‚è¾¼ã‚€
        $("#output").append(str);
      });

      // æ›´æ–°å‡¦ç†
      // ç©ºã£ã½ã®å¤‰æ•°ã‚’ç”¨æ„
      let up_date;
      let up_username;
      let up_text;
      let id;

      $("#update").on("click", function () {
        // ã“ã“ã§è¦ªã®keyã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã‚»ãƒƒãƒˆ è¦ª=å—ä¿¡å‡¦ç†ã®key_id
        // å…¨ã¦ã®trã«å¯¾ã—ã¦å®Ÿè¡Œã‚’ã™ã‚‹ç¹°ã‚Šè¿”ã—å‡¦ç†ã‚’each
        $("tr").each(function (index) {
          console.log(index, "iind");
          var tr = $(this).attr("class");
          // attrãƒ¡ã‚½ãƒƒãƒ‰ï¼šHTMLè¦ç´ ã®å±æ€§ã®å€¤ã‚’å–å¾—ã€å¤‰æ›´ã™ã‚‹éš›ã«ä½¿ç”¨

          id = firebase.database().ref(tr);
          console.log(id);

          up_date = $(this).children(".date").text();
          up_username = $(this).children(".username").text();
          up_text = $(this).children(".text").text();

          // //å¤‰æ•°ã«å…¥ã£ã¦ãã‚‹ã‚‚ã®ã‚’ã‚»ãƒƒãƒˆ
          id.update({
            date: up_date,
            username: up_username,
            text: up_text,
          });
        });

        // ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã®è£æŠ€(ã¡ã‚‡ã£ã¨é•ã†æ›¸ãæ–¹ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯å–ã‚Šæ€¥ã)
        location.href = "";
        //æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
        alert("æ›´æ–°ã—ã¾ã—ãŸ");
      });

      // å‰Šé™¤å‡¦ç†ã€€ï¼ˆå…¨å‰Šé™¤ï¼‰
      $("#Delete").on("click", function () {
        newPostRef.remove(); //realtime databaseã‹ã‚‰æ¶ˆãˆã‚‹
        $("#output").remove(); //ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ¶ˆãˆã‚‹
        alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      });
    </script>
  </body>
</html>
